<!--
@license
Copyright (c) 2015 Marc Kronberg. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/neon-animation-behavior.html">
<link rel="import" href="../neon-animation/neon-animations.html">

<link rel="import" href="argon-swipe-left-right-behavior.html">
<link rel="import" href="argon-slide-horizontal-animation.html">


<dom-module id="argon-swipeable-pages">
    <template>

        <style is="custom-style">
            :host {
                display: block;
            }

            #content {
                position: relative;
                width: 100%;
                height: 100%;
                overflow-x: hidden;
            }

            #content .page {
                position: absolute;
                width: 100%;
                height: 100%;
                background-color: #fff;
                -moz-box-shadow: 0 0 100px 0 rgba(0, 0, 0, 0.22);
                -webkit-box-shadow: 0 0 100px 0 rgba(0, 0, 0, 0.22);
                box-shadow: 0 0 100px 0 rgba(0, 0, 0, 0.22);
            }

            #content .prev-page {
                z-index: 10;
            }

            #content .current-page {
                z-index: 20;
            }

            #content .next-page {
                z-index: 30;
            }
            /* It is a good idea to disable text selection on any of the children that you want to be swiped: */
            .unselectable {
                -moz-user-select: none;
                -ms-user-select: none;
                -webkit-user-select: none;
                user-select: none;
                cursor: default;
            }
        </style>

        <div id="content" on-track="_onTrack">
            <div id="div-a" class="unselectable page prev-page"></div>
            <div id="div-b" class="unselectable page current-page"></div>
            <div id="div-c" class="unselectable page next-page"></div>
        </div>
    </template>

    <script>
        'use strict';

        Polymer({
            is: 'argon-swipeable-pages',
            behaviors: [
                Polymer.NeonAnimationRunnerBehavior,
                Polymer.Templatizer,
                ArgonSwipeLeftRightBehavior
            ],
            properties: {
                /**
                 * The index of the first visible page.
                 */
                pageIndex: {
                    type: Number,
                    value: 0
                },

                /**
                 * The number of dummy items (pages). If one defines this value, it's not necessary to define items.
                 */
                pageCount: {
                    type: Number
                },

                /**
                 * An array containing items determining how many instances of the template
                 * to stamp and that that each template instance should bind to.
                 */
                items: {
                    type: Array
                },

                /**
                 * The name of the variable to add to the binding scope for the array
                 * element associated with a given template instance.
                 */
                as: {
                    type: String,
                    value: 'item'
                },

                /**
                 * The name of the variable to add to the binding scope with the index
                 * for the row.
                 */
                indexAs: {
                    type: String,
                    value: 'index'
                },

                animationRunning: {
                    type: Boolean,
                    value: false
                },
                prevEle: HTMLElement,
                currentEle: HTMLElement,
                nextEle: HTMLElement
            },
            observers: [
                '_createDummyItems(pageCount)',
                '_onItemsChanged(items)'
            ],
            listeners: {
                // this event is fired when the animation finishes
                'neon-animation-finish': '_onNeonAnimationFinish',
                'click': '_onClick'
            },
            _onItemsChanged: function(items) {
                //console.info('items:', this.items);
                this.renderPages();
            },
            _createDummyItems: function(pageCount){
                //console.info('_createDummyItems() pageCount:', pageCount);
                this.items = [];
                if (pageCount) {
                    for (var i = 0; i < pageCount; i++) {
                        this.items.push(i);
                    }
                }
                //console.info('_createDummyItems()', this.items);
            },
            _onNeonAnimationFinish: function (e) {
                this.animationRunning = false;

                this.transform('translate3d(0,0,0)', this.$$('.prev-page'));
                this.transform('translate3d(0,0,0)', this.$$('.current-page'));
                this.transform('translate3d(0,0,0)', this.$$('.next-page'));

                var nextEle = this.$$('.next-page');
                nextEle.style.display = 'none';
            },

            showNext: function (swipe) {
                if (this.animationRunning) return; // skip
                if (this.pageIndex >= this.items.length - 1) return; //skip

                this.pageIndex++;

                var nextEle = this.$$('.next-page');
                var prevEle = this.$$('.prev-page');
                var currentEle = this.$$('.current-page');

                this.transform('translate3d(0,0,0)', this.$$('.prev-page'));
                this.transform('translate3d(0,0,0)', this.$$('.current-page'));

                // translate3d(830px, 0px, 0px) --> 830px
                var fromX = '100%';
                if (swipe) fromX = nextEle.style.transform
                        .replace('translate3d(', '')
                        .replace(')', '')
                        .split(',')[0];

                this.animationConfig = [];
                this.animationConfig.push({
                    name: 'argon-slide-horizontal-animation',
                    node: nextEle,
                    transformFrom: 'translateX(' + fromX +')',
                    transformTo: 'none'
                });

                prevEle.style.display = 'none';
                nextEle.style.display = "block";
                this.animationRunning = true;


                prevEle.classList.remove('prev-page');
                prevEle.classList.add('next-page');

                currentEle.classList.remove('current-page');
                currentEle.classList.add('prev-page');

                nextEle.classList.remove('next-page');
                nextEle.classList.add('current-page');

                this.renderPages();
                this.playAnimation();
            },
            showPrev: function (swipe) {
                if (this.animationRunning) return; // skip
                if (this.pageIndex <= 0) return; //skip

                this.pageIndex--;

                var prevEle = this.$$('.prev-page');
                var currentEle = this.$$('.current-page');
                var nextEle = this.$$('.next-page');

                this.transform('translate3d(0,0,0)', this.$$('.prev-page'));
                this.transform('translate3d(0,0,0)', this.$$('.next-page'));

                var fromX = '0';
                if (swipe) fromX = currentEle.style.transform
                        .replace('translate3d(', '')
                        .replace(')', '')
                        .split(',')[0];

                this.animationConfig = [];
                this.animationConfig.push({
                    name: 'argon-slide-horizontal-animation',
                    node: currentEle,
                    transformFrom: 'translateX(' + fromX +')',
                    transformTo: 'translateX(100%)'
                });
                prevEle.style.display = "block";
                nextEle.style.display = 'none';
                this.animationRunning = true;


                prevEle.classList.remove('prev-page');
                prevEle.classList.add('current-page');

                currentEle.classList.remove('current-page');
                currentEle.classList.add('next-page');

                nextEle.classList.remove('next-page');
                nextEle.classList.add('prev-page');

                this.renderPages();
                this.playAnimation();
            },

            _onClick: function(e){
                if (e.pageX < (this.offsetWidth * 0.1)) {
                    this.showPrev(false);
                } else if (e.pageX > this.offsetWidth * 0.9) {
                    this.showNext(false);
                }
            },

            renderPages: function () {
                if (!this.items) return; // skip
                var prevEle = this.$$('.prev-page');
                var currentEle = this.$$('.current-page');
                var nextEle = this.$$('.next-page');

                this._applyModel(prevEle.model, Math.max(0, this.pageIndex - 1));
                this._applyModel(currentEle.model, this.pageIndex);
                this._applyModel(nextEle.model, Math.min(this.pageIndex + 1, this.items.length - 1));
            },

            _applyModel: function(model, index){
                if (!model) return; // skip
                var item = this.items && this.items[index];
                if (item != null) {
                    model[this.as] = item;
                    model[this.indexAs] = index;
                }
            },

            swipeAnimate: function (dx, target) {
                if (!this.swipeElement) {
                    if (dx < 0) {
                        this.swipeLeft = true;
                        this.swipeElement = this.$$('.next-page');
                        this.swipeElement.style.display = "block";
                    } else {
                        this.swipeLeft = false;
                        this.swipeElement = this.$$('.current-page');
                    }
                }
                var translate;
                if (this.swipeLeft) {
                    if (this.pageIndex >= this.items.length - 1) return; // skip
                    translate = 'translate3d(' + (this.offsetWidth + dx) + 'px,' + 0 + 'px,0)';
                } else {
                    if (this.pageIndex <= 0) return; // skip
                    translate = 'translate3d(' + dx + 'px,' + 0 + 'px,0)';
                }
                this.transform(translate, this.swipeElement);
            },
            swipeEnd: function (swipeDirection, target) {
                this.swipeElement = null;
                if (!swipeDirection) {
                    this.showNext(true);
                } else {
                    this.showPrev(true);
                }
            },

            ready: function () {
                this._transitionProperty = 'opacity, transform';
                this._swipeComplete = false;
                this._direction = '';

                // Get a template from somewhere, e.g. light DOM
                var template = Polymer.dom(this).querySelector('template');

                // Prepare the template
                this.templatize(template);

                var divs = [this.$$('.prev-page'), this.$$('.current-page'), this.$$('.next-page')];
                divs[2].style.display = 'none';

                for (var i = 0; i < divs.length; i++) {
                    var div = divs[i];
                    // Instance the template with an initial data model:
                    var instance = this.stamp({index: 0});
                    // Set data model to 'model':
                    div.model = instance;
                    this._applyModel(div.model, 0);
                    // Insert the instance's DOM somewhere, e.g. light DOM:
                    Polymer.dom(div).appendChild(instance.root);
                }
            },

            attached: function () {
                this.renderPages();
            }
        });
    </script>
</dom-module>